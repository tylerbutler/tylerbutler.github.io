<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>    xkcd 2    : Tyler Butler
</title>

                    
    <link rel="alternate" type="application/atom+xml"
          title="Tyler Butler Atom Feed"
          href="/feeds/atom.xml"/>

                
                                                        <link rel="stylesheet"
                      href="/static/engineer/lib/foundation/stylesheets/grid.css">
                <link rel="stylesheet"
                      href="/static/engineer/lib/foundation/stylesheets/mobile.css">

                <!--[if lt IE 9]>
                    <link rel="stylesheet" href="/static/engineer/lib/foundation/stylesheets/ie.css">
                <![endif]-->
                        
                    
                    
                    <link rel="stylesheet" href="/static/theme/stylesheets/dark_rainbow.css" type="text/css"/>
        
                
                                    
            <script type="text/javascript"
            src="http://use.typekit.net/vty2qol.js"></script>
    <script type="text/javascript">
        try {
            Typekit.load();
        }
        catch (e) {
        }
    </script>
    
            <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26061862-1']);
    _gaq.push(['_setDomainName', 'tylerbutler.com']);

    // track speed for all users; traffic is low enough this shouldn't be a problem
    _gaq.push(['_setSiteSpeedSampleRate', 100]);
    
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>    
                        <script src="/static/engineer/lib/modernizr-2.6.2.min.js"
                    type="text/javascript"></script>
            
            <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
            <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
            <script>
                window.jQuery || document.write('<script src="/static/engineer/lib/jquery-1.10.2.min.js"><\/script>')
            </script>    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body class=""><!--[if lt IE 7]>
    <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->    <div class="container">            <header id="primary" class="row">                                            <h1 class="five columns">
                            <a href="/">                                    tyler
                                    <span class="highlight">butler</span>
                                </a>
                        </h1>
                                                        <nav class="seven columns">                            <ul class="nav navbar-nav">
    
                <li class="current">
        <a href="/">articles</a></li>
                <li>
        <a href="/projects">projects</a></li>
</ul>

                        </nav>
                </header>
        <div class="row">                <section id="main" class="twelve columns"
                         role="main">    <div class="row">
            <div class="post-info two columns">
            <div class="post-date">
                                    <div class="month">MAY</div>
                    <div class="day">17</div>
                    <div class="year">2012</div>
                    <div class="permalink">
                        <a href="/2012/05/xkcd-2/"
                           title="Permanent link to 'xkcd 2'">∞</a>
                    </div>
                            </div>
                                        <ul class="tags">
                                            <li><a href="/tag/project">project</a>
                        </li>
                                            <li><a href="/tag/xkcd2">xkcd2</a>
                        </li>
                                    </ul>
                    </div>
                            <article class="post-content ten columns">
                <time datetime="2012-05-17 PDT"
                      pubdate=""></time>
                <header>
                    <h1>
                        <a href="        /2012/05/xkcd-2/">xkcd 2</a>
                                            </h1>
                </header>
                                    <p>I&#8217;ve just put up a small side project I whipped together over the last day or so called <a href="http://xkcd2.com/">xkcd 2</a>. It might not make much sense why I built this thing, so bear with me while I try to&nbsp;explain.</p>
<h2>Why</h2>
<p>I&#8217;ve been reading <a href="http://xkcd.com/">xkcd</a> for years, but it wasn&#8217;t until fairly recently that I discovered most of the comics actually have a caption.<sup id="fnref:xkcd1"><a class="footnote-ref" href="#fn:xkcd1" rel="footnote">1</a></sup> It&#8217;s tucked away in the <code>title</code> attribute on the <code>img</code> tag, and in most browsers you really only see it if you hover your mouse over the image for a few&nbsp;seconds.</p>
<p>Discovering this was a total accident. I read most xkcd comics via the <span class="caps">RSS</span> feed in <a href="http://reederapp.com/">Reeder</a>. If you zoom-pinch on an image in Reeder, it opens up a view like&nbsp;this:</p>
<div class="image caption center">
    <a href="http://www.flickr.com/photos/76037594@N06/7206331966/">
        <img src="http://farm8.staticflickr.com/7241/7206331966_c6419e544e.jpg" width="500" height="375" alt="An xkcd.com comic in Reeder">
    </a>
    <p>An xkcd.com comic in&nbsp;Reeder</p>
</div>

<p>That panel at the bottom displays the <code>title</code> attribute, but it only shows up if you tap once on the image. Anyway, after coming across this in Reeder, I started looking at all the captions every time a new comic would come out. It turns out that in many cases the caption is funnier than the comic itself. Case in point: <a href="http://xkcd2.com/1049/">comic 1049</a>, the one featured in the picture above, is my most recent favorite. The caption perfectly mirrors my own experience with Ayn Rand, and in my opinion makes the comic that much more interesting as a&nbsp;whole.</p>
<!-- more -->

<p>Anyway, I find it frustrating that the comic captions are not a more visible part of the xkcd site itself, so I decided to put together a separate site that loads the comics from xkcd and simply displays them in a slightly different way &#8211; and includes the comic captions directly. The same comic shown above looks like this on&nbsp;xkcd2.com:</p>
<div class="image caption center">
    <a href="http://www.flickr.com/photos/76037594@N06/7213096382/">
        <img src="http://farm9.staticflickr.com/8151/7213096382_db69df1d70.jpg" width="500" height="361" alt="xkcd2" class="center"/>
    </a>
    <p>An xkcd comic as shown on&nbsp;xkcd2.com</p>
</div>

<h2>How</h2>
<p>Now that you know the <em>why</em> of xkcd2.com, let&#8217;s talk about the <em>how</em>.</p>
<p>xkcd 2 is an exceedingly simple <a href="http://flask.pocoo.org/">Flask</a> app. It&#8217;s ~100 lines of Python (not including empty lines of course). A majority of the time was spent messing with the <span class="caps">HTML</span> and <span class="caps">CSS</span>, not on the Python&nbsp;itself.</p>
<p>Each time a comic is requested, I use the excellent <a href="http://code.google.com/p/httplib2/">httplib2</a> library to retrieve the corresponding page directly from xkcd.com. httplib2 behaves more like a browser than a typical <span class="caps">HTTP</span> library; it handles caching the page content and everything for me, so if the same comic is requested many times httplib2 will return the page content from its local file cache instead of bouncing the request to xkcd.com every time.<sup id="fnref:xkcd2"><a class="footnote-ref" href="#fn:xkcd2" rel="footnote">2</a></sup></p>
<p>Once I get the response and page content from xkcd.com, I parse the page into a <span class="caps">DOM</span> object using <a href="https://github.com/html5lib">html5lib</a>. Then I use some rather inefficient list comprehensions to find the right elements in the <span class="caps">DOM</span> and extract the relevant information. There are probably more efficient means of doing this, but the page structure is simple enough that it&#8217;s not too bad performance-wise. I did find myself desperately wanting server-side jQuery&#8230;<sup id="fnref:xkcd3"><a class="footnote-ref" href="#fn:xkcd3" rel="footnote">3</a></sup></p>
<p>Once I have all the comic details from the page, I store it all in a pickle file so I can load it from the local disk rather than parsing the <span class="caps">HTML</span> on each request. Thus, if httplib2 reports that it used its cached version rather than retrieving a fresh page (via the <code>response.fromcache</code> property), I discard httplib2&#8217;s response entirely and simply load the comic metadata from the pickle&nbsp;file.</p>
<p>Once I have the metadata, I just pass it to the page template and render the&nbsp;page.</p>
<h2>But&#8230;&nbsp;but&#8230;</h2>
<p>I considered a couple of different high-level options before settling on the &#8216;request the page, parse the metadata&#8217; approach. First, since the set of comics is finite (1056 as of this writing), I considered writing a simple scraper that would &#8216;preload&#8217; all of the comics and just load from that cache. However, in the end this isn&#8217;t much different than what I&#8217;m doing. I still would have had to retrieve the page, parse out the relevant data, and store it. The current approach does this lazily, which makes a lot more sense since I doubt most people are looking through really old comics (though it <em>is</em> interesting to see how Munroe&#8217;s style has changed over the years). I still get the benefits without having this separate &#8216;build the cache&#8217;&nbsp;step.</p>
<p>I also considered using the <span class="caps">RSS</span> feed rather than scraping <span class="caps">HTML</span>. This was appealing because the <span class="caps">RSS</span> will be less likely to change format. If xkcd.com undergoes a rewrite, my current <span class="caps">HTML</span> parsing code will probably break.<sup id="fnref:xkcd4"><a class="footnote-ref" href="#fn:xkcd4" rel="footnote">4</a></sup> However, the feed is a snapshot of the most recent comics, not all of them, and I really wanted to support all of them. How broken would it feel if someone sent you a link to a comic on xkcd2.com and it didn&#8217;t load because there was a new comic published that morning and the old comic was no longer in the <span class="caps">RSS</span> feed? Spoiler: very&nbsp;broken.</p>
<p>Anyway, hopefully some folks will find this useful and/or interesting. Code is up <a href="https://github.com/tylerbutler/xkcd2">on github</a> and the site is live at <a href="http://xkcd2.com/">xkcd2.com</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:xkcd1">
<p>Oh, you already knew that? Well good for you.&#160;<a class="footnote-backref" href="#fnref:xkcd1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:xkcd2">
<p>There are no doubt some subtleties in the httplib2 cache behavior that I did not dive into. My hunch is that a request still gets made to xkcd.com &#8211; even just a <code>HEAD</code> request &#8211; because httplib2 needs to somehow determine whether its cache is still valid. I&#8217;m not an expert on its behavior. Regardless, using its cache is almost certainly better than naively proxying the request to xkcd.com &#8211; and waiting for/parsing the response &#8211; each time.&#160;<a class="footnote-backref" href="#fnref:xkcd2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:xkcd3">
<p>This is probably actually possible using node.js, but it seemed like overkill for this project.&#160;<a class="footnote-backref" href="#fnref:xkcd3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:xkcd4">
<p>I do use IDs and classes and avoid relying on actual page structure as much as possible, but sometimes it&#8217;s unavoidable. <span class="caps">HTML</span> scraping is <em>always</em> brittle no matter what precautions you take or how smart you try to be.&#160;<a class="footnote-backref" href="#fnref:xkcd4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                                                                                                                
                    <div class="row">
                        <div class="twelve columns post-links">
                            <ul class="block-grid two-up">
                                <li>
                                                                            <a href="/2012/04/convergence/">← Convergence</a>
                                                                    </li>
                                <li>
                                                                            <a href="/2012/05/how-to-install-python-pip-and-virtualenv-on-windows-with-powershell/">How To Install Python, pip, and virtualenv on Windows with PowerShell →</a>
                                                                    </li>
                            </ul>
                        </div>
                    </div>
                                            </article>
            </div></section>
            </div>
        <div class="row">                <footer class="twelve columns centered">                        <p>&copy; 2002-2013 Tyler Butler. All rights reserved.</p>

<p>Powered by <a href="http://www.tylerbutler.com/projects/engineer">engineer</a>.</p>                    </footer>
            </div>
    </div>
                <script src="/static/engineer/lib/foundation/javascripts/foundation.js"></script>
        
    
    
</body>
</html>